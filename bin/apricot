#!/usr/bin/env ruby

file = __FILE__
file = File.readlink(file) while File.symlink? file
$LOAD_PATH.unshift(File.expand_path('../../lib', file))

require 'apricot'

evals = []
options = Rubinius::Options.new "Usage: #{$0} [options] [program]", 20
options.doc "OPTIONS:"

options.on "-h", "--help", "Display this help" do
  puts options
  exit
end

options.on "-e", "CODE", "evaluate CODE and print the result" do |code|
  evals << [:eval, code]
end

options.parse(ARGV).each do |file|
  evals << [:file, file]
end

if evals.empty?
  if $stdin.tty?
	require 'readline'
	while code = Readline.readline("apr> ")
	  cm = Apricot::Compiler.compile_string code
	  print "=> "
	  p Rubinius.run_script(cm)
	end
  else
	evals << [:eval, STDIN.read, "(stdin)"]
  end
end

evals.each do |type, *args|
  case type
  when :eval
	cm = Apricot::Compiler.compile_string *args
	Rubinius.run_script cm
  when :file
	cm = Apricot::Compiler.compile arg
	Rubinius.run_script cm
  end
end
